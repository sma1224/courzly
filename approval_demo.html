<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courzly Approval Workflow Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-approved { @apply bg-green-100 text-green-800; }
        .status-rejected { @apply bg-red-100 text-red-800; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">Courzly Approval Workflow Demo</h1>
            
            <!-- Controls -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
                <div class="flex space-x-4">
                    <button id="createWorkflow" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Create Test Workflow
                    </button>
                    <button id="checkApprovals" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Check Pending Approvals
                    </button>
                    <button id="approveAll" class="bg-emerald-500 text-white px-4 py-2 rounded hover:bg-emerald-600">
                        Approve All
                    </button>
                    <button id="rejectAll" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Reject All
                    </button>
                </div>
            </div>

            <!-- Status Display -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Workflow Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Workflow Status</h3>
                    <div id="workflowStatus" class="space-y-2">
                        <p class="text-gray-500">No workflow created yet</p>
                    </div>
                </div>

                <!-- Pending Approvals -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">Pending Approvals</h3>
                    <div id="pendingApprovals" class="space-y-2">
                        <p class="text-gray-500">No pending approvals</p>
                    </div>
                </div>
            </div>

            <!-- Approval History -->
            <div class="bg-white rounded-lg shadow p-6 mt-6">
                <h3 class="text-lg font-semibold mb-4">Approval History</h3>
                <div id="approvalHistory" class="space-y-2">
                    <p class="text-gray-500">No approval history</p>
                </div>
            </div>

            <!-- Logs -->
            <div class="bg-gray-900 text-green-400 rounded-lg p-4 mt-6">
                <h3 class="text-lg font-semibold mb-4 text-white">Console Logs</h3>
                <div id="logs" class="font-mono text-sm space-y-1 max-h-64 overflow-y-auto">
                    <p>Ready to test approval workflow...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentWorkflowId = null;
        let authToken = null;

        // Logging function
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                success: 'text-blue-400',
                warning: 'text-yellow-400'
            };
            
            const logEntry = document.createElement('p');
            logEntry.className = colors[type] || 'text-green-400';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // API helper
        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Initialize with mock auth (for demo)
        async function initAuth() {
            // For demo purposes, we'll simulate authentication
            authToken = 'demo-token';
            log('Demo authentication initialized', 'success');
        }

        // Create test workflow
        async function createWorkflow() {
            try {
                log('Creating test workflow...', 'info');
                
                const workflowData = {
                    title: 'Demo Course - Approval Test',
                    description: 'Testing approval workflow functionality',
                    config: {
                        course_topic: 'Web Development Fundamentals',
                        target_audience: 'Beginners',
                        duration: '6 weeks'
                    }
                };

                const workflow = await apiCall('/api/workflows/course/create', {
                    method: 'POST',
                    body: JSON.stringify(workflowData)
                });

                currentWorkflowId = workflow.id;
                log(`Workflow created: ${workflow.id}`, 'success');
                updateWorkflowStatus(workflow);
                
                // Start checking for approvals
                setTimeout(checkPendingApprovals, 2000);
                
            } catch (error) {
                log(`Failed to create workflow: ${error.message}`, 'error');
            }
        }

        // Check pending approvals
        async function checkPendingApprovals() {
            if (!currentWorkflowId) {
                log('No workflow ID available', 'warning');
                return;
            }

            try {
                const approvals = await apiCall(`/api/hitl/${currentWorkflowId}/pending-approvals`);
                log(`Found ${approvals.length} pending approval(s)`, 'info');
                updatePendingApprovals(approvals);
                
                if (approvals.length > 0) {
                    log('Workflow is waiting for approval', 'warning');
                }
                
            } catch (error) {
                log(`Failed to check approvals: ${error.message}`, 'error');
            }
        }

        // Approve all pending
        async function approveAll() {
            if (!currentWorkflowId) {
                log('No workflow ID available', 'warning');
                return;
            }

            try {
                const approvalData = {
                    status: 'approved',
                    comments: 'Approved via demo interface'
                };

                await apiCall(`/api/hitl/${currentWorkflowId}/approve`, {
                    method: 'POST',
                    body: JSON.stringify(approvalData)
                });

                log('Checkpoint approved successfully', 'success');
                
                // Refresh status and check for more approvals
                setTimeout(() => {
                    updateWorkflowStatusFromAPI();
                    checkPendingApprovals();
                }, 1000);
                
            } catch (error) {
                log(`Failed to approve: ${error.message}`, 'error');
            }
        }

        // Reject all pending
        async function rejectAll() {
            if (!currentWorkflowId) {
                log('No workflow ID available', 'warning');
                return;
            }

            try {
                const approvalData = {
                    status: 'rejected',
                    comments: 'Rejected via demo interface - needs revision'
                };

                await apiCall(`/api/hitl/${currentWorkflowId}/approve`, {
                    method: 'POST',
                    body: JSON.stringify(approvalData)
                });

                log('Checkpoint rejected successfully', 'success');
                
                // Refresh status
                setTimeout(() => {
                    updateWorkflowStatusFromAPI();
                    checkPendingApprovals();
                }, 1000);
                
            } catch (error) {
                log(`Failed to reject: ${error.message}`, 'error');
            }
        }

        // Update workflow status display
        function updateWorkflowStatus(workflow) {
            const statusDiv = document.getElementById('workflowStatus');
            statusDiv.innerHTML = `
                <div class="space-y-2">
                    <p><strong>ID:</strong> ${workflow.id}</p>
                    <p><strong>Title:</strong> ${workflow.title}</p>
                    <p><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs font-medium status-${workflow.status.toLowerCase()}">${workflow.status}</span></p>
                    <p><strong>Stage:</strong> ${workflow.current_stage}</p>
                    <p><strong>Created:</strong> ${new Date(workflow.created_at).toLocaleString()}</p>
                </div>
            `;
        }

        // Update workflow status from API
        async function updateWorkflowStatusFromAPI() {
            if (!currentWorkflowId) return;

            try {
                const workflow = await apiCall(`/api/workflows/${currentWorkflowId}/status`);
                updateWorkflowStatus(workflow);
            } catch (error) {
                log(`Failed to update status: ${error.message}`, 'error');
            }
        }

        // Update pending approvals display
        function updatePendingApprovals(approvals) {
            const approvalsDiv = document.getElementById('pendingApprovals');
            
            if (approvals.length === 0) {
                approvalsDiv.innerHTML = '<p class="text-gray-500">No pending approvals</p>';
                return;
            }

            approvalsDiv.innerHTML = approvals.map(approval => `
                <div class="border rounded p-3 bg-yellow-50">
                    <p class="font-medium">${approval.stage.replace('_', ' ').toUpperCase()}</p>
                    <p class="text-sm text-gray-600">Created: ${new Date(approval.created_at).toLocaleString()}</p>
                    <p class="text-sm text-gray-600">ID: ${approval.checkpoint_id}</p>
                </div>
            `).join('');
        }

        // Event listeners
        document.getElementById('createWorkflow').addEventListener('click', createWorkflow);
        document.getElementById('checkApprovals').addEventListener('click', checkPendingApprovals);
        document.getElementById('approveAll').addEventListener('click', approveAll);
        document.getElementById('rejectAll').addEventListener('click', rejectAll);

        // Initialize
        initAuth();
        
        // Auto-refresh pending approvals every 10 seconds
        setInterval(() => {
            if (currentWorkflowId) {
                checkPendingApprovals();
                updateWorkflowStatusFromAPI();
            }
        }, 10000);
    </script>
</body>
</html>